{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": None,
   "id": "0c699db1-9b67-4dcf-a48a-204b798d8063",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2025-11-10 18:22:00.014 WARNING streamlit.runtime.scriptrunner_utils.script_run_context: Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.014 WARNING streamlit.runtime.scriptrunner_utils.script_run_context: Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.112 \n",
      "  \u001b[33m\u001b[1mWarning:\u001b[0m to view this Streamlit app on a browser, run it with the following\n",
      "  command:\n",
      "\n",
      "    streamlit run /opt/homebrew/Caskroom/miniforge/base/envs/quant/lib/python3.11/site-packages/ipykernel_launcher.py [ARGUMENTS]\n",
      "2025-11-10 18:22:00.112 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.112 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.112 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.113 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.113 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.113 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.113 Session state does not function when running a script without `streamlit run`\n",
      "2025-11-10 18:22:00.113 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.113 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.114 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.114 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.114 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.114 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.114 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.117 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.118 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.119 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.120 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.121 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.121 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.121 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2025-11-10 18:22:00.122 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
     ]
    }
   ],
   "source": [
    "# ==========================================\n",
    "# ğŸ“Š äº¤äº’å¼é‡åŒ–æŠ•èµ„ä»ªè¡¨ç›˜ï¼ˆTushare Pro ç‰ˆï¼‰\n",
    "# ==========================================\n",
    "import tushare as ts\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import ta\n",
    "import matplotlib.pyplot as plt\n",
    "import streamlit as st\n",
    "from xgboost import XGBClassifier\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.metrics import accuracy_score\n",
    "\n",
    "# ==========================================\n",
    "# âš™ï¸ åˆå§‹åŒ–\n",
    "# ==========================================\n",
    "st.set_page_config(page_title=\"Aè‚¡é‡åŒ–æŠ•èµ„ä»ªè¡¨ç›˜\", layout=\"wide\")\n",
    "st.title(\"ğŸ“ˆ Aè‚¡é‡åŒ–æŠ•èµ„æœºå™¨å­¦ä¹ ä»ªè¡¨ç›˜ï¼ˆTushare Pro ç‰ˆï¼‰\")\n",
    "\n",
    "# è¾“å…¥ Token\n",
    "token = st.text_input(\"è¯·è¾“å…¥ä½ çš„ Tushare Pro Tokenï¼š\", type=\"password\")\n",
    "if not token:\n",
    "    st.warning(\"è¯·è¾“å…¥æœ‰æ•ˆçš„ Tushare Token åç»§ç»­ã€‚\")\n",
    "    st.stop()\n",
    "\n",
    "ts.set_token(token)\n",
    "pro = ts.pro_api()\n",
    "\n",
    "# ==========================================\n",
    "# ğŸ§­ ç”¨æˆ·è¾“å…¥\n",
    "# ==========================================\n",
    "col1, col2, col3 = st.columns(3)\n",
    "with col1:\n",
    "    stock = st.text_input(\"è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 000001.SZï¼‰\", \"000001.SZ\")\n",
    "with col2:\n",
    "    start_date = st.text_input(\"èµ·å§‹æ—¥æœŸ (YYYYMMDD)\", \"20180101\")\n",
    "with col3:\n",
    "    end_date = st.text_input(\"ç»“æŸæ—¥æœŸ (YYYYMMDD)\", \"20251101\")\n",
    "\n",
    "if st.button(\"ğŸš€ è·å–å¹¶è®­ç»ƒæ¨¡å‹\"):\n",
    "    with st.spinner(\"æ­£åœ¨è·å–æ•°æ®å¹¶è®­ç»ƒæ¨¡å‹...\"):\n",
    "        # â‘  è·å–è¡Œæƒ…æ•°æ®\n",
    "        daily = pro.daily(ts_code=stock, start_date=start_date, end_date=end_date)\n",
    "        basic = pro.daily_basic(ts_code=stock, start_date=start_date, end_date=end_date,\n",
    "                                fields='ts_code,trade_date,pe,pb,turnover_rate,volume_ratio,total_mv')\n",
    "        df = pd.merge(daily, basic, on=['ts_code', 'trade_date'])\n",
    "        df = df.sort_values('trade_date').reset_index(drop=True)\n",
    "\n",
    "        if df.empty:\n",
    "            st.error(\"âŒ æœªè·å–åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æˆ–æƒé™ã€‚\")\n",
    "            st.stop()\n",
    "\n",
    "        # â‘¡ ç‰¹å¾å·¥ç¨‹\n",
    "        df['MA5'] = df['close'].rolling(window=5).mean()\n",
    "        df['MA20'] = df['close'].rolling(window=20).mean()\n",
    "        df['RSI'] = ta.momentum.RSIIndicator(df['close']).rsi()\n",
    "        df['MACD'] = ta.trend.MACD(df['close']).macd()\n",
    "        df['VOL5'] = df['vol'].rolling(5).mean()\n",
    "        df['RET5'] = df['close'].pct_change(5)\n",
    "        df['turnover_rate'] = pd.to_numeric(df['turnover_rate'], errors='coerce')\n",
    "        df['pe'] = pd.to_numeric(df['pe'], errors='coerce')\n",
    "        df['pb'] = pd.to_numeric(df['pb'], errors='coerce')\n",
    "        df['target'] = (df['close'].shift(-1) > df['close']).astype(int)\n",
    "        df = df.dropna()\n",
    "\n",
    "        features = ['MA5','MA20','RSI','MACD','VOL5','RET5','pe','pb','turnover_rate','volume_ratio']\n",
    "        X = df[features]\n",
    "        y = df['target']\n",
    "\n",
    "        # â‘¢ æ¨¡å‹è®­ç»ƒ\n",
    "        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, shuffle=False)\n",
    "        model = XGBClassifier(max_depth=4, n_estimators=300, learning_rate=0.05, subsample=0.8)\n",
    "        model.fit(X_train, y_train)\n",
    "        y_pred = model.predict(X_test)\n",
    "        acc = accuracy_score(y_test, y_pred)\n",
    "\n",
    "        # â‘£ ç­–ç•¥å›æµ‹\n",
    "        df_test = df.iloc[len(X_train):].copy()\n",
    "        df_test['pred'] = y_pred\n",
    "        df_test['signal'] = df_test['pred'].shift(1).fillna(0)\n",
    "        df_test['return'] = df_test['close'].pct_change()\n",
    "        df_test['strategy_return'] = df_test['signal'] * df_test['return']\n",
    "\n",
    "        initial_capital = 1_000_000\n",
    "        df_test['equity_curve'] = initial_capital * (1 + df_test['strategy_return']).cumprod()\n",
    "        df_test['benchmark'] = initial_capital * (1 + df_test['return']).cumprod()\n",
    "\n",
    "        # â‘¤ ç»©æ•ˆæŒ‡æ ‡\n",
    "        total_return = df_test['equity_curve'].iloc[-1] / initial_capital - 1\n",
    "        benchmark_return = df_test['benchmark'].iloc[-1] / initial_capital - 1\n",
    "        win_rate = (df_test['strategy_return'] > 0).mean()\n",
    "        sharpe = np.mean(df_test['strategy_return']) / np.std(df_test['strategy_return']) * np.sqrt(252)\n",
    "        drawdown = (df_test['equity_curve'] / df_test['equity_curve'].cummax() - 1).min()\n",
    "\n",
    "        # ==========================================\n",
    "        # ğŸ“ˆ ç»˜å›¾\n",
    "        # ==========================================\n",
    "        st.subheader(f\"ğŸ“Š ç­–ç•¥ç»©æ•ˆæ€»ç»“ï¼š{stock}\")\n",
    "        st.write(f\"âœ… æ¨¡å‹é¢„æµ‹å‡†ç¡®ç‡ï¼š{acc:.2%}\")\n",
    "        st.write(f\"ç­–ç•¥æ€»æ”¶ç›Š: {total_return:.2%}\")\n",
    "        st.write(f\"åŸºå‡†æ”¶ç›Š: {benchmark_return:.2%}\")\n",
    "        st.write(f\"èƒœç‡: {win_rate:.2%}\")\n",
    "        st.write(f\"å¤æ™®æ¯”ç‡: {sharpe:.2f}\")\n",
    "        st.write(f\"æœ€å¤§å›æ’¤: {drawdown:.2%}\")\n",
    "\n",
    "        # æ”¶ç›Šæ›²çº¿å›¾\n",
    "        fig, ax = plt.subplots(figsize=(10, 5))\n",
    "        ax.plot(df_test['trade_date'], df_test['equity_curve'], label='ç­–ç•¥èµ„é‡‘æ›²çº¿', linewidth=2)\n",
    "        ax.plot(df_test['trade_date'], df_test['benchmark'], label='åŸºå‡†ï¼ˆä¹°å…¥æŒæœ‰ï¼‰', linestyle='--')\n",
    "        ax.legend()\n",
    "        ax.set_title(f'{stock} ç­–ç•¥ vs åŸºå‡† æ”¶ç›Šæ›²çº¿')\n",
    "        st.pyplot(fig)\n",
    "\n",
    "        # ç»©æ•ˆä»ªè¡¨ç›˜\n",
    "        metrics = ['æ€»æ”¶ç›Š','åŸºå‡†æ”¶ç›Š','èƒœç‡','å¤æ™®æ¯”ç‡','æœ€å¤§å›æ’¤']\n",
    "        values = [total_return, benchmark_return, win_rate, sharpe/5, -drawdown]\n",
    "        fig2, ax2 = plt.subplots()\n",
    "        bars = ax2.bar(metrics, values, color=['#4caf50','#607d8b','#03a9f4','#ff9800','#f44336'])\n",
    "        for i, v in enumerate(values):\n",
    "            ax2.text(i, v + 0.01, f\"{v:.2%}\" if i != 3 else f\"{sharpe:.2f}\", ha='center')\n",
    "        ax2.set_title(\"ç­–ç•¥ç»©æ•ˆæŒ‡æ ‡\")\n",
    "        st.pyplot(fig2)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": None,
   "id": "91b1c671-f987-486f-a842-f14b2963172b",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (quant)",
   "language": "python",
   "name": "quant"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.14"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
